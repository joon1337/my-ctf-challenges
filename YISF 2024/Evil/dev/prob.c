#include <stdio.h>
#include <string.h>
#include <openssl/sha.h>

char answer1[0x100] = {0, };
char answer2[0x100] = {0, };
char answer3[0x100] = {0, };

void stage1(void);
void stage2(void);
void stage3(void);
void print_flag(void);

void banner() {
    char* str =
"╔════════════════════════════════════════════════════╗\n"
"║ ▄         ▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄ ║\n"
"║▐░▌       ▐░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌║\n"
"║▐░▌       ▐░▌ ▀▀▀▀█░█▀▀▀▀ ▐░█▀▀▀▀▀▀▀▀▀ ▐░█▀▀▀▀▀▀▀▀▀ ║\n"
"║▐░▌       ▐░▌     ▐░▌     ▐░▌          ▐░▌          ║\n"
"║▐░█▄▄▄▄▄▄▄█░▌     ▐░▌     ▐░█▄▄▄▄▄▄▄▄▄ ▐░█▄▄▄▄▄▄▄▄▄ ║\n"
"║▐░░░░░░░░░░░▌     ▐░▌     ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌║\n"
"║ ▀▀▀▀█░█▀▀▀▀      ▐░▌      ▀▀▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀▀▀ ║\n"
"║     ▐░▌          ▐░▌               ▐░▌▐░▌          ║\n"
"║     ▐░▌      ▄▄▄▄█░█▄▄▄▄  ▄▄▄▄▄▄▄▄▄█░▌▐░▌          ║\n"
"║     ▐░▌     ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░▌          ║\n"
"║      ▀       ▀▀▀▀▀▀▀▀▀▀▀  ▀▀▀▀▀▀▀▀▀▀▀  ▀           ║\n"
"║                                                    ║\n"
"║ ▄▄▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄▄▄  ▄         ▄ ║\n"
"║▐░░░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░░░▌▐░▌       ▐░▌║\n"
"║ ▀▀▀▀▀▀▀▀▀█░▌▐░█░█▀▀▀▀▀█░▌ ▀▀▀▀▀▀▀▀▀█░▌▐░▌       ▐░▌║\n"
"║          ▐░▌▐░▌▐░▌    ▐░▌          ▐░▌▐░▌       ▐░▌║\n"
"║          ▐░▌▐░▌ ▐░▌   ▐░▌          ▐░▌▐░█▄▄▄▄▄▄▄█░▌║\n"
"║ ▄▄▄▄▄▄▄▄▄█░▌▐░▌  ▐░▌  ▐░▌ ▄▄▄▄▄▄▄▄▄█░▌▐░░░░░░░░░░░▌║\n"
"║▐░░░░░░░░░░░▌▐░▌   ▐░▌ ▐░▌▐░░░░░░░░░░░▌ ▀▀▀▀▀▀▀▀▀█░▌║\n"
"║▐░█▀▀▀▀▀▀▀▀▀ ▐░▌    ▐░▌▐░▌▐░█▀▀▀▀▀▀▀▀▀           ▐░▌║\n"
"║▐░█▄▄▄▄▄▄▄▄▄ ▐░█▄▄▄▄▄█░█░▌▐░█▄▄▄▄▄▄▄▄▄           ▐░▌║\n"
"║▐░░░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░░░▌          ▐░▌║\n"
"║ ▀▀▀▀▀▀▀▀▀▀▀   ▀▀▀▀▀▀▀▀▀   ▀▀▀▀▀▀▀▀▀▀▀            ▀ ║\n"
"╚════════════════════════════════════════════════════╝";
    puts(str);
}

void bomb() {
    char* str = 
"\n                       .....**####*............                      \n"
"                       .:**##+===++**##*****+:..                     \n"
"      ..................##**+=-======++===+***+...:.............     \n"
"     .....:+++*..-********+===---==-======+*********+==**++*+...     \n"
"     ...=*+========--==**+======--==-+======+###+======----=+*:.   . \n"
"     .-*++=------===---++++=======---+======++%=====--------==+*.... \n"
"     .:#+====-----+-=--+++=-====-:----:-::-==+=====-----==--==**.... \n"
" ....-#*++======------*++=========--::::--::-=++=-------=======++-.. \n"
" ....**#+++======----=**+++=-------::-=--=====+**=--=-=======++**+.. \n"
" ....:*#*+=======--===#*+==--==-===--======+=++*===--=--=====++#-... \n"
"     ..***+++========##***++=+======-====++++**++==========+++*#:... \n"
"     :***#*++=+++++===+*#***++++++++*++++++*#***++++++++++++**#**... \n"
"     .:*****#*****+*%%######*****+*++*#########%%##*******##****...  \n"
"     ..*******#*#########*****###*######*****#####*****#*******=     \n"
"     ...:=*******#***#***###**++*+=-:-:-+=*#******#####**+===:..     \n"
"       .......=++=+=+==+=***#*+=+:::--:=+=#**+*******++.......       \n"
"          ..-+*+*=:==-:++*=**#+==--:---=+*#******=+*-.......         \n"
"       ...:=*-:......... ...##*=----=--*+#*...........=++-:...       \n"
"          .......:::.:-.    -**+==--=-=*+#+.......:-==---::...       \n"
"          ..................:#**==--===###....................       \n"
"                ....:..::-:+=**+=---==-*+*==+:::...                  \n"
"                  ......:....-%*+====+=#%%........                   \n"
"                       ...++=+%#++==++-+++*-.....                    \n"
"                    ....::*+==#*=++++*+#*+#-=:.::..                  \n"
"                   . ...:=*=++#++++++*+******+*:...                  \n"
"     .....  .. ..  ......****#**+=**+==+#***++++-....          ..    \n"
"     ..:.. ...-.. ..+==+++****+==------==*+++++++=:................  \n"
"       .=-........-+===---=*++===-----===+*==+++*+*....-.:...-:.     \n"
" -:... ....-...:+*++=----==*====---======*+==---=+*.+=+:...*=...:..  \n"
" ...=+:::.:+**++=+*+=======*+==+==-===--=*========*===+*++=.:-...... \n"
" .....:-=++++*++++**+++++++**+++++======+*++===++**++++**++*--++-... \n"
"     .......::.:=+:.-=-+***+--*++++++++*=.+*****+-.:--..::.......... ";
    puts(str);
    exit(-1);
}

void win() {
    char* str =
"\n ╔═══════════════════════════════════════════════╗ \n"
" ║ ▄         ▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄        ▄       ▄ ║ \n"
" ║▐░▌       ▐░▌▐░░░░░░░░░░░▌▐░░▌      ▐░▌     ▐░▌║ \n"
" ║▐░▌       ▐░▌ ▀▀▀▀█░█▀▀▀▀ ▐░▌░▌     ▐░▌     ▐░▌║ \n"
" ║▐░▌       ▐░▌     ▐░▌     ▐░▌▐░▌    ▐░▌     ▐░▌║ \n"
" ║▐░▌   ▄   ▐░▌     ▐░▌     ▐░▌ ▐░▌   ▐░▌     ▐░▌║ \n"
" ║▐░▌  ▐░▌  ▐░▌     ▐░▌     ▐░▌  ▐░▌  ▐░▌     ▐░▌║ \n"
" ║▐░▌ ▐░▌░▌ ▐░▌     ▐░▌     ▐░▌   ▐░▌ ▐░▌     ▐░▌║ \n"
" ║▐░▌▐░▌ ▐░▌▐░▌     ▐░▌     ▐░▌    ▐░▌▐░▌      ▀ ║ \n"
" ║▐░▌░▌   ▐░▐░▌ ▄▄▄▄█░█▄▄▄▄ ▐░▌     ▐░▐░▌      ▄ ║ \n"
" ║▐░░▌     ▐░░▌▐░░░░░░░░░░░▌▐░▌      ▐░░▌     ▐░▌║ \n"
" ║ ▀▀       ▀▀  ▀▀▀▀▀▀▀▀▀▀▀  ▀        ▀▀       ▀ ║ \n"
" ╚═══════════════════════════════════════════════╝ ";
    puts(str);
}

#define strlen_wrapper(str) ({           \
    const char *s = (str);       \
    size_t len = 0;              \
    while (*s++) len++;          \
    len;                         \
})

#define abs(n) ((n) >= 0 ? (n) : -(n))

int find(char* buf, char c) {
    for (int i=0; i<strlen_wrapper(buf); i++) {
        if (buf[i] == c) {
            return 1;
        }
    }
    return 0;
}

void init() __attribute__((constructor));
void init() {
    setvbuf(stdin, 0, 2, 0);
    setvbuf(stdout, 0, 2, 0);
    return;
}

void stage1() {
    char* buf = answer1;
    int len = 0;
    unsigned char key[] = {12, 31, 29, 33, 85, 37, 6, 102, 60, 62, 44, 56, 84, 31, 42, 43, 66, 7, 29, 90, 85, 44, 79, 20, 50, 64, 18, 3, 119, 54, 49, 55, 28, 46, 6, 68, 22, 75, 92, 52, 67, 105, 12, 68, 46, 59, 88, 92, 15, 72, 14, 95, 65, 122, 35, 92, 52, 16, 17, 45, 59, 59, 34, 8, 85, 20, 25, 72, 47, 6, 52, 68, 28, 86, 100, 67, 50, 25};
    unsigned char table[] = {91, 122, 113, 66, 58, 72, 99, 71, 99, 118, 77, 78, 49, 64, 83, 68, 55, 88, 110, 53, 57, 90, 42, 112, 109, 52, 122, 102, 40, 84, 94, 90, 126, 113, 100, 33, 112, 36, 46, 81, 124, 54, 69, 34, 113, 66, 55, 41, 80, 44, 103, 59, 109, 37, 74, 40, 107, 103, 126, 88, 87, 95, 125, 106, 48, 75, 124, 41, 92, 127, 107, 34, 115, 36, 59, 58, 93, 108};

    puts("\n[+] Stage 1");
    puts("[+] What's the answer?");
    printf("[>] ");
    len = read(0, answer1, sizeof(answer1)-1);
    answer1[len-1] = 0;

    if (strlen_wrapper(buf) != 78) {
        bomb();
    }

    for (int i=0; i<strlen_wrapper(buf); i++) {
        if (((buf[i] ^ key[i]) & 0xff) != table[i]) {
            bomb();
        }
    }
    stage2();
}

typedef struct Node {
    struct Node* left;
    struct Node* right;
    size_t val;
} Node;

Node n21 = {
    .left = 0,
    .right = 0,
    .val = 21
};

Node n19 = {
    .left = &n21,
    .right = 0,
    .val = 19
};

Node n20 = {
    .left = 0,
    .right = 0,
    .val = 20
};

Node n18 = {
    .left = &n19,
    .right = &n20,
    .val = 18
};

Node n17 = {
    .left = 0,
    .right = 0,
    .val = 17
};

Node n16 = {
    .left = &n17,
    .right = &n18,
    .val = 16
};

Node n15 = {
    .left = 0,
    .right = 0,
    .val = 15
};

Node n14 = {
    .left = 0,
    .right = 0,
    .val = 14
};

Node n8 = {
    .left = 0,
    .right = 0,
    .val = 8
};

Node n9 = {
    .left = &n14,
    .right = &n15,
    .val = 9 
};

Node n10 = {
    .left = 0,
    .right = 0,
    .val = 10
};

Node n11 = {
    .left = &n16,
    .right = 0,
    .val = 11
};

Node n12 = {
    .left = 0,
    .right = 0,
    .val = 12
};

Node n13 = {
    .left = 0,
    .right = 0,
    .val = 13
};

Node n4 = {
    .left = &n8,
    .right = &n9,
    .val = 4
};

Node n5 = {
    .left = &n10,
    .right = &n11,
    .val = 5
};

Node n6 = {
    .left = 0,
    .right = 0,
    .val = 6
};

Node n7 = {
    .left = &n12,
    .right = &n13,
    .val = 7
};

Node n2 = {
    .left = &n4,
    .right = &n5,
    .val = 2
};

Node n3 = {
    .left = &n6,
    .right = &n7,
    .val = 3
};

Node n1 = {
    .left = &n2,
    .right = &n3,
    .val = 1
};

void stage2() {
    char* buf = answer2;
    int len = 0;
    int haystack[10] = {0, };
    puts("\n[+] Stage 2");
    puts("[+] What's the answer?");
    printf("[>] ");

    len = read(0, answer2, sizeof(answer2)-1);
    answer2[len-1] = 0;

    for (int i=0; i<len-1; i++) {
        if ((buf[i] != 'a') && (buf[i] != 'b')) {
            bomb();
        }
        haystack[i] = buf[i] - 'a';
    }

    Node* ptr = &n1;
    int flag = 0;
    for (int i=0; i < len; i++) {
        if (!flag && !ptr) {
            bomb();
        }
        if (ptr->val == 21) {
            flag = 1;
            buf[i] = 0;
            break;
        }
        if (haystack[i] == 0) {
            ptr = ptr->left;
        }
        else if (haystack[i] == 1) {
            ptr = ptr->right;
        }
    }
    if (flag) {
        stage3();
    }
    else {
        bomb();
    }
}

void stage3() {
    unsigned char diff[] = {33, 8, 24, 22, 22, 2, 12, 14, 3, 3, 2, 12, 2, 8, 6, 27, 33, 4, 19, 12, 60, 72, 12, 
                                         3, 6, 5, 1, 14, 1, 2, 3, 10, 20, 13, 19, 16, 9, 7, 24, 8, 3, 6, 8, 15};
    char table[] = {44, 68, 73, 78, 95, 97, 98, 99, 100, 101, 102, 104, 108, 109, 111, 114, 115, 116, 119, 121};
    char* buf = answer3;
    int len = 0;
    size_t xor = 0;

    puts("\n[+] Stage 3");
    puts("[+] What's the answer?");
    printf("[>] ");
    len = read(0, answer3, sizeof(answer3)-1);
    answer3[len-1] = 0;

    if (strlen_wrapper(buf) != 45) {
        bomb();
    }
    
    for (int i=0; i<strlen_wrapper(buf); i++) {
        if (!find(table, buf[i])) {
            bomb();
        }
        xor ^= buf[i];
    }

    if (xor != 43) {
        bomb();
    }

    for (int i=0; i<strlen_wrapper(buf)-1; i++) {
        if (abs(buf[i] - buf[i+1]) != diff[i]) {
            bomb();
        }
    }
    print_flag();
}

unsigned char hash1[] = {237, 214, 255, 225, 7, 164, 41, 0, 209, 86, 53, 119, 40, 233, 
125, 82, 87, 116, 200, 15, 180, 187, 88, 115, 58, 133, 219, 117, 69, 7, 19, 41, 47, 
115, 87, 141, 225, 239, 219, 153, 90, 27, 42, 63, 40, 148, 64, 204, 146, 90, 104, 203, 
58, 206, 0, 30, 4, 121, 130, 14, 125, 90, 133, 76};
unsigned char hash2[] = {187, 165, 90, 178, 182, 6, 117, 30, 169, 235, 21, 190, 231, 135, 
169, 26, 197, 196, 15, 198, 109, 33, 60, 71, 197, 177, 204, 225, 143, 241, 209, 14, 189,
 84, 229, 157, 68, 205, 233, 151, 253, 144, 14, 19, 32, 161, 89, 158, 212, 229, 68, 249, 
 42, 88, 143, 68, 175, 189, 234, 176, 250, 30, 198, 121};
unsigned char hash3[] = {39, 111, 112, 160, 235, 14, 108, 12, 233, 72, 46, 155, 119, 219, 
84, 208, 225, 233, 154, 228, 37, 54, 93, 205, 110, 246, 56, 233, 255, 113, 128, 66, 181, 
111, 135, 243, 81, 156, 127, 240, 221, 174, 218, 221, 30, 129, 242, 100, 143, 81, 139, 231,
 200, 180, 147, 250, 225, 163, 88, 223, 12, 100, 56, 116};

void print_flag() {
    unsigned char hash[SHA512_DIGEST_LENGTH+1] = {0, };
    
    memset(hash, 0, sizeof(hash));
    SHA512(answer1, strlen((const char *)answer1), hash);
    if(memcmp(hash, hash1, SHA512_DIGEST_LENGTH)) {
        bomb();
    }

    memset(hash, 0, sizeof(hash));
    SHA512(answer2, strlen((const char *)answer2), hash);
    if(memcmp(hash, hash2, SHA512_DIGEST_LENGTH)) {
        bomb();
    }

    memset(hash, 0, sizeof(hash));
    SHA512(answer3, strlen((const char *)answer3), hash);
    if(memcmp(hash, hash3, SHA512_DIGEST_LENGTH)) {
        bomb();
    }
    
    char* flag = calloc(sizeof(char), 0x1000);
    strcpy(flag, answer1);
    strcat(flag, answer2);
    strcat(flag, answer3);
    
    memset(hash, 0, sizeof(hash));
    SHA512(flag, strlen((const char *)flag), hash);

    win();
    puts("");
    printf("YISF{");
    for (int i = 0; i < SHA512_DIGEST_LENGTH; i++) {
        printf("%02x", hash[i]);
    }
    printf("}\n");

}

int main() {
    int flag = 0xdeadbeef;

    banner();
    for (int i=0; i<2; i++) {
        puts("");
    }
    if (flag) {
        stage1();
    }
    else {
        bomb();
    }
}